name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode
        run: |
          set -euo pipefail
          DEVELOPER_DIR="/Applications/Xcode.app/Contents/Developer"
          if ls /Applications/Xcode_*.app >/dev/null 2>&1; then
            LATEST_XCODE="$(ls -d /Applications/Xcode_*.app | sort -V | tail -1)"
            DEVELOPER_DIR="$LATEST_XCODE/Contents/Developer"
          fi
          echo "Using DEVELOPER_DIR=$DEVELOPER_DIR"
          sudo xcode-select -s "$DEVELOPER_DIR"
      - name: Toolchain info
        run: |
          xcodebuild -version
          xcrun swift --version
      - name: Assert Swift 6.2
        run: xcrun swift --version 2>&1 | grep -E "Swift version 6\\.2"
      - name: Install linters
        run: brew install swiftlint swiftformat
      - name: SwiftFormat
        run: swiftformat Sources Tests Examples --lint
      - name: SwiftLint
        run: swiftlint lint --strict --config .swiftlint.yml
      - name: Swift test + coverage
        run: swift test --enable-code-coverage -Xswiftc -warnings-as-errors
      - name: Assert 70% coverage
        run: ./scripts/check-coverage.sh 70
      - name: Swift build example
        run: (cd Examples/ElevenLabsKitExample && swift build -Xswiftc -warnings-as-errors)
      - name: Swift build CLI example
        run: (cd Examples/ElevenLabsKitCLI && swift build -Xswiftc -warnings-as-errors)
